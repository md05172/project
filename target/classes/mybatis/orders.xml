<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="orders">

	<insert id="address">
		INSERT INTO address
		VALUES (SEQ_ADDRESS.nextval, #{id}, #{address[0].postcode}, #{address[0].roadaddress}, #{address[0].jibunaddress}, #{address[0].detailaddress}, #{address[0].extraaddress})
		
		<selectKey keyColumn="id" keyProperty="address[0].id" resultType="Long" order="AFTER">
			SELECT SEQ_ADDRESS.currval FROM dual
		</selectKey>
	</insert>

	<select id="check" resultType="Address">
		SELECT * FROM address
		WHERE cust_id = #{custId}
		AND postcode = #{postcode}
		AND roadaddress = #{roadaddress}
		AND jibunaddress = #{jibunaddress}
		AND extraaddress = #{extraaddress}
	</select>
	
	<insert id="add">
		INSERT INTO ORDERS
		VALUES (SEQ_ORDERS.nextval, #{custId}, #{addressId}, SYSDATE, #{code})
		
		<selectKey keyProperty="id" resultType="Long" order="AFTER">
			SELECT SEQ_ORDERS.currval FROM dual		
		</selectKey>
		
	</insert>	
	
	<select id="order_check" resultType="Orders">
		SELECT * FROM orders
		WHERE code = #{orderId}
	</select>
	
	
	<insert id="add_detail">
		INSERT INTO orders_detail
		VALUES (SEQ_ORDERSDETAIL.nextval, #{ordersId}, #{bookId}, #{amount})
	</insert>
	
	<resultMap type="Orders" id="OrdersMap" autoMapping="true">
		<id column="id" property="id" javaType="Long"/>
		
		<collection column="orders_id" property="details" javaType="ArrayList" ofType="OrdersDetail" autoMapping="true">
			<id column="detail_id" property="id" javaType="Long"/>
		</collection>
	</resultMap>
	
	<!-- 회원이 주문한 주문목록을 가져온다 -->
	<select id="list" resultMap="OrdersMap">
		SELECT orders.*,
			orders_detail.id detail_id,
			orders_detail.orders_id orders_id,
			orders_detail.book_id, 
			orders_detail.amount
		FROM orders
		JOIN orders_detail
		ON orders.id = orders_detail.orders_id
		WHERE cust_id = #{customerId}
	</select>
	
</mapper>